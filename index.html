<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call - QR Connect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { background: #2a2a2a; border-radius: 10px; padding: 20px; margin: 20px 0; }
        h1 { text-align: center; margin-bottom: 30px; color: #4CAF50; }
        h2 { margin-bottom: 15px; color: #4CAF50; }
        button { background: #4CAF50; color: white; border: none; padding: 15px 30px; 
                 font-size: 16px; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #45a049; }
        button:disabled { background: #666; cursor: not-allowed; }
        .btn-danger { background: #f44336; }
        .btn-danger:hover { background: #da190b; }
        #qrcode { display: flex; justify-content: center; margin: 20px 0; }
        #reader { max-width: 500px; margin: 0 auto; }
        .video-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; }
        video { width: 100%; max-width: 500px; background: #000; border-radius: 10px; }
        .hidden { display: none; }
        .status { padding: 10px; background: #333; border-radius: 5px; margin: 10px 0; }
        .incoming-call { background: #ff9800; padding: 20px; border-radius: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¥ Video Call - QR Connect</h1>
        
        <div id="setupSection" class="section">
            <h2>Step 1: Generate Your QR Code</h2>
            <button id="generateBtn" onclick="generateQR()">Generate My QR Code</button>
            <div id="qrcode"></div>
            <div id="roomInfo" class="status hidden"></div>
        </div>

        <div id="scanSection" class="section">
            <h2>Step 2: Scan QR Code to Connect</h2>
            <button id="scanBtn" onclick="startScan()">Start QR Scanner</button>
            <button id="stopScanBtn" onclick="stopScan()" class="hidden">Stop Scanner</button>
            <div id="reader"></div>
        </div>

        <div id="incomingCallSection" class="section hidden">
            <div class="incoming-call">
                <h2>ðŸ“ž Incoming Call...</h2>
                <p>Someone wants to video call with you</p>
                <button onclick="acceptCall()">Accept</button>
                <button class="btn-danger" onclick="rejectCall()">Reject</button>
            </div>
        </div>

        <div id="callSection" class="section hidden">
            <h2>Video Call</h2>
            <div class="status" id="callStatus">Connecting...</div>
            <button id="callBtn" onclick="initiateCall()" class="hidden">Start Video Call</button>
            <button id="endCallBtn" onclick="endCall()" class="btn-danger hidden">End Call</button>
            <div class="video-container">
                <div>
                    <h3>You</h3>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <div>
                    <h3>Remote</h3>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let roomId;
        let peerId;
        let peerConnection;
        let localStream;
        let html5QrCode;
        let isInitiator = false;
        let remoteRoomId;

        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            
            ws.onopen = () => console.log('Connected to server');
            
            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                
                switch(data.type) {
                    case 'room-created':
                        roomId = data.roomId;
                        peerId = data.peerId;
                        showQRCode();
                        break;
                    case 'peer-joined':
                        document.getElementById('callStatus').textContent = 'Peer connected. Ready to call.';
                        document.getElementById('callBtn').classList.remove('hidden');
                        break;
                    case 'call-request':
                        showIncomingCall();
                        break;
                    case 'call-accepted':
                        startCall();
                        break;
                    case 'call-rejected':
                        alert('Call was rejected');
                        document.getElementById('callBtn').classList.remove('hidden');
                        break;
                    case 'offer':
                        await handleOffer(data.offer);
                        break;
                    case 'answer':
                        await handleAnswer(data.answer);
                        break;
                    case 'ice-candidate':
                        await handleIceCandidate(data.candidate);
                        break;
                    case 'call-ended':
                        endCall();
                        alert('Call ended by peer');
                        break;
                }
            };
            
            ws.onerror = (error) => console.error('WebSocket error:', error);
            ws.onclose = () => console.log('Disconnected from server');
        }

        function generateQR() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Connecting to server... Please wait and try again.');
                return;
            }
            isInitiator = true;
            ws.send(JSON.stringify({ type: 'create-room' }));
        }

        function showQRCode() {
            const url = `${window.location.origin}?room=${roomId}`;
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            
            // Create QR using canvas
            const canvas = document.createElement('canvas');
            qrDiv.appendChild(canvas);
            
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrDiv, {
                    text: url,
                    width: 256,
                    height: 256
                });
            } else {
                // Fallback: show URL as text
                qrDiv.innerHTML = `<div style="background: white; padding: 20px; color: black; border-radius: 10px;"><strong>Share this link:</strong><br><a href="${url}" style="color: blue; word-break: break-all;">${url}</a></div>`;
            }
            
            document.getElementById('roomInfo').innerHTML = `<strong>Room ID:</strong> ${roomId}<br><strong>Share this QR code to connect</strong>`;
            document.getElementById('roomInfo').classList.remove('hidden');
            document.getElementById('generateBtn').disabled = true;
        }

        function startScan() {
            html5QrCode = new Html5Qrcode("reader");
            document.getElementById('scanBtn').classList.add('hidden');
            document.getElementById('stopScanBtn').classList.remove('hidden');
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    stopScan();
                    const url = new URL(decodedText);
                    const room = url.searchParams.get('room');
                    if (room) {
                        joinRoom(room);
                    }
                }
            ).catch(err => console.error('Scanner error:', err));
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop();
                document.getElementById('scanBtn').classList.remove('hidden');
                document.getElementById('stopScanBtn').classList.add('hidden');
            }
        }

        function joinRoom(room) {
            remoteRoomId = room;
            ws.send(JSON.stringify({ type: 'join-room', roomId: room }));
            document.getElementById('callSection').classList.remove('hidden');
            document.getElementById('callStatus').textContent = 'Connected to room. Waiting...';
        }

        function showIncomingCall() {
            document.getElementById('incomingCallSection').classList.remove('hidden');
        }

        function acceptCall() {
            document.getElementById('incomingCallSection').classList.add('hidden');
            ws.send(JSON.stringify({ type: 'call-response', accepted: true, roomId }));
            startCall();
        }

        function rejectCall() {
            document.getElementById('incomingCallSection').classList.add('hidden');
            ws.send(JSON.stringify({ type: 'call-response', accepted: false, roomId }));
        }

        function initiateCall() {
            document.getElementById('callBtn').classList.add('hidden');
            ws.send(JSON.stringify({ type: 'call-request', roomId: remoteRoomId }));
        }

        async function startCall() {
            document.getElementById('callSection').classList.remove('hidden');
            document.getElementById('endCallBtn').classList.remove('hidden');
            document.getElementById('callBtn').classList.add('hidden');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('localVideo').srcObject = localStream;
                
                peerConnection = new RTCPeerConnection(config);
                
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                peerConnection.ontrack = (event) => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    document.getElementById('callStatus').textContent = 'Call connected';
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        ws.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: event.candidate,
                            roomId: roomId || remoteRoomId
                        }));
                    }
                };
                
                if (isInitiator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    ws.send(JSON.stringify({
                        type: 'offer',
                        offer: offer,
                        roomId: remoteRoomId
                    }));
                }
            } catch (error) {
                console.error('Error starting call:', error);
                alert('Could not access camera/microphone');
            }
        }

        async function handleOffer(offer) {
            if (!peerConnection) await startCall();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            ws.send(JSON.stringify({
                type: 'answer',
                answer: answer,
                roomId
            }));
        }

        async function handleAnswer(answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        async function handleIceCandidate(candidate) {
            if (peerConnection) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('endCallBtn').classList.add('hidden');
            document.getElementById('callStatus').textContent = 'Call ended';
            
            if (roomId || remoteRoomId) {
                ws.send(JSON.stringify({
                    type: 'end-call',
                    roomId: roomId || remoteRoomId
                }));
            }
        }

        // Auto-join if room parameter exists
        window.onload = () => {
            connectWebSocket();
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            if (room) {
                setTimeout(() => joinRoom(room), 1000);
            }
        };
    </script>
</body>
</html>
