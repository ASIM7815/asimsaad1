<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Video Call - QR Connect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="error-handler.js"></script>
    <style>
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin: 20px 0; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        h2 { margin-bottom: 20px; font-size: 1.5em; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; 
                 font-size: 18px; border-radius: 50px; cursor: pointer; margin: 10px 5px; font-weight: bold;
                 box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        button:disabled { background: #666; cursor: not-allowed; transform: none; }
        .btn-danger { background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); }
        .qr-container { display: flex; justify-content: center; margin: 30px 0; }
        .qr-wrapper { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; position: relative; }
        .qr-wrapper::before { content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; background: linear-gradient(135deg, #667eea, #764ba2, #f093fb); border-radius: 22px; z-index: -1; }
        .qr-logo { width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        .qr-title { color: #333; font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        #qrcode { margin: 20px 0; }
        #qrcode img { border-radius: 10px; }
        .qr-footer { color: #666; font-size: 14px; margin-top: 15px; }
        #reader { max-width: 500px; margin: 0 auto; border-radius: 10px; overflow: hidden; }
        .video-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        video { width: 100%; max-width: 500px; background: #000; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            h1 { font-size: 1.8em; }
            .section { padding: 20px; }
            video { max-width: 100%; }
            button { padding: 12px 30px; font-size: 16px; }
            .video-container { flex-direction: column; }
        }
        .hidden { display: none; }
        .status { padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 15px 0; text-align: center; font-size: 16px; }
        .status.success { background: rgba(76, 175, 80, 0.3); }
        .status.error { background: rgba(244, 67, 54, 0.3); }
        .status.warning { background: rgba(255, 152, 0, 0.3); }
        .incoming-call { background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .error-toast { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 10px; color: white; font-weight: bold; z-index: 9999; animation: slideIn 0.3s; }
        .error-toast.error { background: linear-gradient(135deg, #f44336, #e91e63); }
        .error-toast.warning { background: linear-gradient(135deg, #ff9800, #ff5722); }
        .error-toast.success { background: linear-gradient(135deg, #4caf50, #8bc34a); }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <h1> Video Call - QR Connect</h1>
        
        <div id="permissionSection" class="section">
            <h2>ðŸŽ¥ Enable Camera & Microphone</h2>
            <p style="text-align: center; margin-bottom: 20px;">Allow access to start video calling</p>
            <div style="text-align: center;">
                <button id="permissionBtn" onclick="requestPermissions()">Allow Camera & Microphone</button>
            </div>
        </div>
        
        <div id="setupSection" class="section">
            <h2>Step 1: Generate Your QR Code</h2>
            <button id="generateBtn" onclick="generateQR()">Generate My QR Code</button>
            <div class="qr-container" id="qrContainer" style="display:none;">
                <div class="qr-wrapper">
                    <div class="qr-logo">ðŸ“ž</div>
                    <div class="qr-title">Scan to Connect</div>
                    <div id="qrcode"></div>
                    <div class="qr-footer">Scan with any device to join video call</div>
                </div>
            </div>
            <div id="roomInfo" class="status hidden"></div>
        </div>

        <div id="scanSection" class="section">
            <h2>Step 2: Scan QR Code to Connect</h2>
            <button id="scanBtn" onclick="startScan()">Start QR Scanner</button>
            <button id="stopScanBtn" onclick="stopScan()" class="hidden">Stop Scanner</button>
            <div id="reader"></div>
        </div>

        <div id="incomingCallSection" class="section hidden">
            <div class="incoming-call">
                <h2>ðŸ“ž Incoming Call...</h2>
                <p>Someone wants to video call with you</p>
                <button onclick="acceptCall()">Accept</button>
                <button class="btn-danger" onclick="rejectCall()">Reject</button>
            </div>
        </div>

        <div id="callSection" class="section hidden">
            <h2>Video Call</h2>
            <div class="status" id="callStatus">Connecting...</div>
            <button id="callBtn" onclick="initiateCall()" class="hidden">Start Video Call</button>
            <button id="endCallBtn" onclick="endCall()" class="btn-danger hidden">End Call</button>
            <div class="video-container">
                <div>
                    <h3>You</h3>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <div>
                    <h3>Remote</h3>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let roomId;
        let peerId;
        let peerConnection;
        let localStream;
        let html5QrCode;
        let isInitiator = false;
        let remoteRoomId;
        let pendingIceCandidates = [];

        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10
        };

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('callStatus');
            statusEl.textContent = message;
            statusEl.className = 'status';
            if (type !== 'info') statusEl.classList.add(type);
        }

        function sendMessage(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            } else {
                showStatus('Connection lost. Please refresh.', 'error');
            }
        }

        function connectWebSocket() {
            ws = new WebSocket(`wss://${window.location.host}`);
            
            ws.onopen = () => console.log('Connected to server');
            
            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                
                switch(data.type) {
                    case 'room-created':
                        roomId = data.roomId;
                        peerId = data.peerId;
                        showQRCode();
                        break;
                    case 'peer-joined':
                        document.getElementById('callStatus').textContent = 'Peer connected. Ready to call.';
                        document.getElementById('callBtn').classList.remove('hidden');
                        break;
                    case 'call-request':
                        showIncomingCall();
                        break;
                    case 'call-accepted':
                        startCall();
                        break;
                    case 'call-rejected':
                        showStatus('Call was rejected', 'error');
                        document.getElementById('callBtn').classList.remove('hidden');
                        break;
                    case 'offer':
                        await handleOffer(data.offer);
                        break;
                    case 'answer':
                        await handleAnswer(data.answer);
                        break;
                    case 'ice-candidate':
                        await handleIceCandidate(data.candidate);
                        break;
                    case 'call-ended':
                        endCall();
                        showStatus('Call ended by peer', 'warning');
                        break;
                }
            };
            
            ws.onerror = (error) => ErrorHandler.handleWebSocketError(error);
            ws.onclose = () => ErrorHandler.handleWebSocketClose();
        }

        function generateQR() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showStatus('Connecting to server... Please wait.', 'warning');
                return;
            }
            isInitiator = true;
            sendMessage({ type: 'create-room' });
        }

        function showQRCode() {
            const url = `${window.location.origin}?room=${roomId}`;
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrDiv, {
                    text: url,
                    width: 256,
                    height: 256,
                    colorDark: "#5a67d8",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
            
            document.getElementById('qrContainer').style.display = 'flex';
            document.getElementById('roomInfo').innerHTML = `<strong>Room ID:</strong> ${roomId}`;
            document.getElementById('roomInfo').classList.remove('hidden');
            document.getElementById('generateBtn').disabled = true;
        }

        function startScan() {
            html5QrCode = new Html5Qrcode("reader");
            document.getElementById('scanBtn').classList.add('hidden');
            document.getElementById('stopScanBtn').classList.remove('hidden');
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    stopScan();
                    const url = new URL(decodedText);
                    const room = url.searchParams.get('room');
                    if (room) {
                        joinRoom(room);
                    }
                }
            ).catch(err => console.error('Scanner error:', err));
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop();
                document.getElementById('scanBtn').classList.remove('hidden');
                document.getElementById('stopScanBtn').classList.add('hidden');
            }
        }

        function joinRoom(room) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showStatus('Connecting... Please wait.', 'warning');
                setTimeout(() => joinRoom(room), 1000);
                return;
            }
            remoteRoomId = room;
            sendMessage({ type: 'join-room', roomId: room });
            document.getElementById('callSection').classList.remove('hidden');
            showStatus('Connected to room. Waiting...');
        }

        function showIncomingCall() {
            document.getElementById('incomingCallSection').classList.remove('hidden');
        }

        function acceptCall() {
            document.getElementById('incomingCallSection').classList.add('hidden');
            sendMessage({ type: 'call-response', accepted: true, roomId });
            startCall();
        }

        function rejectCall() {
            document.getElementById('incomingCallSection').classList.add('hidden');
            sendMessage({ type: 'call-response', accepted: false, roomId });
        }

        function initiateCall() {
            document.getElementById('callBtn').classList.add('hidden');
            sendMessage({ type: 'call-request', roomId: remoteRoomId });
        }

        async function startCall() {
            document.getElementById('callSection').classList.remove('hidden');
            document.getElementById('endCallBtn').classList.remove('hidden');
            document.getElementById('callBtn').classList.add('hidden');
            
            try {
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: isMobile ? 640 : 1280 },
                        height: { ideal: isMobile ? 480 : 720 },
                        facingMode: isMobile ? 'user' : 'user'
                    }, 
                    audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                peerConnection = new RTCPeerConnection(config);
                
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                
                peerConnection.ontrack = (event) => {
                    const remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo.srcObject !== event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                    }
                    showStatus('Call connected', 'success');
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate && ws && ws.readyState === WebSocket.OPEN) {
                        sendMessage({
                            type: 'ice-candidate',
                            candidate: event.candidate,
                            roomId: roomId || remoteRoomId
                        });
                    }
                };
                
                peerConnection.onconnectionstatechange = () => {
                    if (peerConnection.connectionState === 'connected') {
                        showStatus('Call connected', 'success');
                    } else if (peerConnection.connectionState === 'failed') {
                        showStatus('Connection failed', 'error');
                        ErrorHandler.handleConnectionError();
                    }
                };
                
                if (isInitiator) {
                    const offer = await peerConnection.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    await peerConnection.setLocalDescription(offer);
                    sendMessage({ type: 'offer', offer: offer, roomId: remoteRoomId });
                }
            } catch (error) {
                showStatus('Media access failed', 'error');
                ErrorHandler.handleMediaError(error);
            }
        }

        async function handleOffer(offer) {
            if (!peerConnection) await startCall();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            
            // Process pending ICE candidates
            while (pendingIceCandidates.length > 0) {
                const candidate = pendingIceCandidates.shift();
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('Error adding pending ICE candidate:', error);
                }
            }
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            sendMessage({ type: 'answer', answer: answer, roomId });
        }

        async function handleAnswer(answer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            
            // Process pending ICE candidates
            while (pendingIceCandidates.length > 0) {
                const candidate = pendingIceCandidates.shift();
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('Error adding pending ICE candidate:', error);
                }
            }
        }

        async function handleIceCandidate(candidate) {
            if (!peerConnection) {
                console.log('Peer connection not ready, queuing ICE candidate');
                return;
            }
            
            if (peerConnection.remoteDescription && peerConnection.remoteDescription.type) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                } catch (error) {
                    console.error('Error adding ICE candidate:', error);
                }
            } else {
                pendingIceCandidates.push(candidate);
            }
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    track.stop();
                    track.enabled = false;
                });
                localStream = null;
            }
            
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            localVideo.srcObject = null;
            remoteVideo.srcObject = null;
            
            document.getElementById('endCallBtn').classList.add('hidden');
            showStatus('Call ended');
            
            if (roomId || remoteRoomId) {
                sendMessage({ type: 'end-call', roomId: roomId || remoteRoomId });
            }
            
            pendingIceCandidates = [];
        }

        async function requestPermissions() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                stream.getTracks().forEach(track => {
                    track.stop();
                    track.enabled = false;
                });
                document.getElementById('permissionBtn').textContent = 'âœ“ Permissions Granted';
                document.getElementById('permissionBtn').disabled = true;
                showStatus('Camera and microphone access granted!', 'success');
            } catch (error) {
                console.error('Permission denied:', error);
                showStatus('Permission denied. Please allow camera and microphone access.', 'error');
            }
        }

        window.onload = () => {
            connectWebSocket();
            const room = new URLSearchParams(window.location.search).get('room');
            if (room) setTimeout(() => joinRoom(room), 2000);
        };
    </script>
</body>
</html>
