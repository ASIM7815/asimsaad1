<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call - QR Connect</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin: 20px 0; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        h1 { text-align: center; margin-bottom: 30px; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        h2 { margin-bottom: 20px; font-size: 1.5em; }
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; 
                 font-size: 18px; border-radius: 50px; cursor: pointer; margin: 10px 5px; font-weight: bold;
                 box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        button:disabled { background: #666; cursor: not-allowed; transform: none; }
        .btn-danger { background: linear-gradient(135deg, #f44336 0%, #e91e63 100%); }
        .qr-container { display: flex; justify-content: center; margin: 30px 0; }
        .qr-wrapper { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); text-align: center; position: relative; }
        .qr-wrapper::before { content: ''; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px; background: linear-gradient(135deg, #667eea, #764ba2, #f093fb); border-radius: 22px; z-index: -1; }
        .qr-logo { width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 30px; }
        .qr-title { color: #333; font-size: 20px; font-weight: bold; margin-bottom: 15px; }
        #qrcode { margin: 20px 0; }
        #qrcode img { border-radius: 10px; }
        .qr-footer { color: #666; font-size: 14px; margin-top: 15px; }
        #reader { max-width: 500px; margin: 0 auto; border-radius: 10px; overflow: hidden; }
        .video-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        video { width: 100%; max-width: 500px; background: #000; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .hidden { display: none; }
        .status { padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 15px 0; text-align: center; font-size: 16px; }
        .incoming-call { background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¥ Video Call - QR Connect</h1>
        
        <div id="setupSection" class="section">
            <h2>Step 1: Generate Your QR Code</h2>
            <button id="generateBtn" onclick="generateQR()">Generate My QR Code</button>
            <div class="qr-container" id="qrContainer" style="display:none;">
                <div class="qr-wrapper">
                    <div class="qr-logo">ðŸ“ž</div>
                    <div class="qr-title">Scan to Connect</div>
                    <div id="qrcode"></div>
                    <div class="qr-footer">Scan with any device to join video call</div>
                </div>
            </div>
            <div id="roomInfo" class="status hidden"></div>
        </div>

        <div id="scanSection" class="section">
            <h2>Step 2: Scan QR Code to Connect</h2>
            <button id="scanBtn" onclick="startScan()">Start QR Scanner</button>
            <button id="stopScanBtn" onclick="stopScan()" class="hidden">Stop Scanner</button>
            <div id="reader"></div>
        </div>

        <div id="incomingCallSection" class="section hidden">
            <div class="incoming-call">
                <h2>ðŸ“ž Incoming Call...</h2>
                <p>Someone wants to video call with you</p>
                <button onclick="acceptCall()">Accept</button>
                <button class="btn-danger" onclick="rejectCall()">Reject</button>
            </div>
        </div>

        <div id="callSection" class="section hidden">
            <h2>Video Call</h2>
            <div class="status" id="callStatus">Connecting...</div>
            <button id="callBtn" onclick="initiateCall()" class="hidden">Start Video Call</button>
            <button id="endCallBtn" onclick="endCall()" class="btn-danger hidden">End Call</button>
            <div class="video-container">
                <div>
                    <h3>You</h3>
                    <video id="localVideo" autoplay muted playsinline></video>
                </div>
                <div>
                    <h3>Remote</h3>
                    <video id="remoteVideo" autoplay playsinline></video>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let roomId;
        let peerId;
        let peerConnection;
        let localStream;
        let html5QrCode;
        let isInitiator = false;
        let remoteRoomId;

        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10
        };

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}`);
            
            ws.onopen = () => console.log('Connected to server');
            
            ws.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data);
                
                switch(data.type) {
                    case 'room-created':
                        roomId = data.roomId;
                        peerId = data.peerId;
                        showQRCode();
                        break;
                    case 'peer-joined':
                        document.getElementById('callStatus').textContent = 'Peer connected. Ready to call.';
                        document.getElementById('callBtn').classList.remove('hidden');
                        break;
                    case 'call-request':
                        showIncomingCall();
                        break;
                    case 'call-accepted':
                        startCall();
                        break;
                    case 'call-rejected':
                        alert('Call was rejected');
                        document.getElementById('callBtn').classList.remove('hidden');
                        break;
                    case 'offer':
                        await handleOffer(data.offer);
                        break;
                    case 'answer':
                        await handleAnswer(data.answer);
                        break;
                    case 'ice-candidate':
                        await handleIceCandidate(data.candidate);
                        break;
                    case 'call-ended':
                        endCall();
                        alert('Call ended by peer');
                        break;
                }
            };
            
            ws.onerror = (error) => console.error('WebSocket error:', error);
            ws.onclose = () => console.log('Disconnected from server');
        }

        function generateQR() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('Connecting to server... Please wait and try again.');
                return;
            }
            isInitiator = true;
            ws.send(JSON.stringify({ type: 'create-room' }));
        }

        function showQRCode() {
            const url = `${window.location.origin}?room=${roomId}`;
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrDiv, {
                    text: url,
                    width: 256,
                    height: 256,
                    colorDark: "#5a67d8",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
            
            document.getElementById('qrContainer').style.display = 'flex';
            document.getElementById('roomInfo').innerHTML = `<strong>ðŸ”‘ Room ID:</strong> ${roomId}`;
            document.getElementById('roomInfo').classList.remove('hidden');
            document.getElementById('generateBtn').disabled = true;
        }

        function startScan() {
            html5QrCode = new Html5Qrcode("reader");
            document.getElementById('scanBtn').classList.add('hidden');
            document.getElementById('stopScanBtn').classList.remove('hidden');
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    stopScan();
                    const url = new URL(decodedText);
                    const room = url.searchParams.get('room');
                    if (room) {
                        joinRoom(room);
                    }
                }
            ).catch(err => console.error('Scanner error:', err));
        }

        function stopScan() {
            if (html5QrCode) {
                html5QrCode.stop();
                document.getElementById('scanBtn').classList.remove('hidden');
                document.getElementById('stopScanBtn').classList.add('hidden');
            }
        }

        function joinRoom(room) {
            remoteRoomId = room;
            ws.send(JSON.stringify({ type: 'join-room', roomId: room }));
            document.getElementById('callSection').classList.remove('hidden');
            document.getElementById('callStatus').textContent = 'Connected to room. Waiting...';
        }

        function showIncomingCall() {
            document.getElementById('incomingCallSection').classList.remove('hidden');
        }

        function acceptCall() {
            document.getElementById('incomingCallSection').classList.add('hidden');
            ws.send(JSON.stringify({ type: 'call-response', accepted: true, roomId }));
            startCall();
        }

        function rejectCall() {
            document.getElementById('incomingCallSection').classList.add('hidden');
            ws.send(JSON.stringify({ type: 'call-response', accepted: false, roomId }));
        }

        function initiateCall() {
            document.getElementById('callBtn').classList.add('hidden');
            ws.send(JSON.stringify({ type: 'call-request', roomId: remoteRoomId }));
        }

        async function startCall() {
            console.log('ðŸŽ¥ Starting call...');
            document.getElementById('callSection').classList.remove('hidden');
            document.getElementById('endCallBtn').classList.remove('hidden');
            document.getElementById('callBtn').classList.add('hidden');
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                console.log('âœ… Got local stream');
                document.getElementById('localVideo').srcObject = localStream;
                
                peerConnection = new RTCPeerConnection(config);
                console.log('âœ… Created peer connection');
                
                localStream.getTracks().forEach(track => {
                    console.log('âž• Adding track:', track.kind);
                    peerConnection.addTrack(track, localStream);
                });
                
                peerConnection.ontrack = (event) => {
                    console.log('ðŸ“¥ Received remote track:', event.track.kind);
                    const remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo.srcObject !== event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                        console.log('âœ… Set remote stream');
                    }
                    document.getElementById('callStatus').textContent = 'âœ… Call connected';
                };
                
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('ðŸ§Š Sending ICE candidate');
                        ws.send(JSON.stringify({
                            type: 'ice-candidate',
                            candidate: event.candidate,
                            roomId: roomId || remoteRoomId
                        }));
                    }
                };
                
                peerConnection.onconnectionstatechange = () => {
                    console.log('ðŸ”— Connection state:', peerConnection.connectionState);
                };
                
                if (isInitiator) {
                    console.log('ðŸ“¤ Creating offer...');
                    const offer = await peerConnection.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    await peerConnection.setLocalDescription(offer);
                    console.log('âœ… Set local description');
                    ws.send(JSON.stringify({
                        type: 'offer',
                        offer: offer,
                        roomId: remoteRoomId
                    }));
                    console.log('ðŸ“¤ Sent offer');
                }
            } catch (error) {
                console.error('âŒ Error starting call:', error);
                alert('Could not access camera/microphone: ' + error.message);
            }
        }

        async function handleOffer(offer) {
            console.log('ðŸ“¥ Received offer');
            if (!peerConnection) {
                await startCall();
            }
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            console.log('âœ… Set remote description (offer)');
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            console.log('âœ… Created and set answer');
            
            ws.send(JSON.stringify({
                type: 'answer',
                answer: answer,
                roomId
            }));
            console.log('ðŸ“¤ Sent answer');
        }

        async function handleAnswer(answer) {
            console.log('ðŸ“¥ Received answer');
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            console.log('âœ… Set remote description (answer)');
        }

        async function handleIceCandidate(candidate) {
            console.log('ðŸ“¥ Received ICE candidate');
            if (peerConnection && peerConnection.remoteDescription) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    console.log('âœ… Added ICE candidate');
                } catch (error) {
                    console.error('âŒ Error adding ICE candidate:', error);
                }
            }
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('endCallBtn').classList.add('hidden');
            document.getElementById('callStatus').textContent = 'Call ended';
            
            if (roomId || remoteRoomId) {
                ws.send(JSON.stringify({
                    type: 'end-call',
                    roomId: roomId || remoteRoomId
                }));
            }
        }

        // Auto-join if room parameter exists
        window.onload = () => {
            connectWebSocket();
            const urlParams = new URLSearchParams(window.location.search);
            const room = urlParams.get('room');
            if (room) {
                setTimeout(() => joinRoom(room), 1000);
            }
        };
    </script>
</body>
</html>
